{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-5">
            {% if codigo_invitacion %}
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading">
                        <i class="bi bi-envelope-check me-2"></i>Registro por Invitación
                    </h6>
                    <p class="mb-0">Has sido invitado(a) a participar en este evento. Tu correo electrónico ya está confirmado.</p>
                </div>
            {% endif %}
            
            <h2 class="text-center text-primary mb-4">Preinscribirse como Participante</h2>
            <p class="text-center text-muted mb-4">Evento: <strong>{{ evento.eve_nombre }}</strong></p>

            <!-- FORM principal -->
            <form id="formPrincipal"
                  action="{% if codigo_invitacion %}{% url 'registro_con_codigo' codigo_invitacion.codigo %}{% else %}{% url 'inscribirse_participante' evento.eve_id %}{% endif %}"
                  method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Campo oculto para el código cuando no viene de invitación -->
                {% if codigo and not codigo_invitacion %}
                    <input type="hidden" name="codigo" value="{{ codigo }}">
                {% endif %}
                
                <!-- Campo oculto para es_integrante_extra -->
                {% if es_integrante_extra %}
                    <input type="hidden" name="es_integrante_extra" value="true">
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Identificación</label>
                        <input type="text" name="par_id" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Teléfono</label>
                        <input type="text" name="par_telefono" class="form-control" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Nombres</label>
                        <input type="text" name="par_nombres" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Apellidos</label>
                        <input type="text" name="par_apellidos" class="form-control" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Correo Electrónico</label>
                    {% if email_prefijado %}
                        <input type="email" name="par_correo" class="form-control bg-light" value="{{ email_prefijado }}" readonly>
                        <small class="text-muted">Correo confirmado por invitación</small>
                        {% if codigo_invitacion %}
                            <input type="hidden" name="codigo" value="{{ codigo_invitacion.codigo }}">
                        {% endif %}
                    {% else %}
                        <input type="email" name="par_correo" class="form-control" required>
                    {% endif %}
                </div>

                <!-- Tipo de participación - Solo mostrar si NO es integrante extra -->
                {% if not es_integrante_extra %}
                    <div class="mb-4">
                        <label class="form-label">Tipo de Participación</label>
                        <select name="tipo_participacion" id="tipo_participacion" class="form-select" required>
                            <option value="">Seleccione...</option>
                            <option value="individual">Individual</option>
                            <option value="grupal">Grupal</option>
                        </select>
                    </div>

                    <!-- Campos del proyecto principal -->
                    <div id="proyecto_fields" class="mb-4" style="display:none;">
                        <label class="form-label">Título del Proyecto</label>
                        <input type="text" name="titulo_proyecto" class="form-control mb-2" required>

                        <label class="form-label">Descripción</label>
                        <textarea name="descripcion_proyecto" class="form-control mb-2" required></textarea>

                        <label class="form-label">Archivo del Proyecto</label>
                        <input type="file" name="archivo_proyecto" class="form-control" accept=".pdf,.zip,.rar,.doc,.docx" required>

                        <!-- Botón para registrar proyectos adicionales -->
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-success" onclick="abrirModalProyecto()">
                                <i class="bi bi-folder-plus"></i> Inscribir otro proyecto
                            </button>
                        </div>
                    </div>

                    <!-- Botón para agregar integrantes en proyectos grupales -->
                    <div id="grupal_extra" class="mb-4" style="display:none;">
                        <button type="button" class="btn btn-outline-primary mb-3" onclick="abrirModalIntegrante()">
                            <i class="bi bi-person-plus"></i> Inscribir a otro expositor
                        </button>
                    </div>
                {% else %}
                    <!-- Para integrantes adicionales -->
                    <input type="hidden" name="tipo_participacion" value="grupal">
                    
                    <div class="alert alert-info mb-4">
                        <h6><i class="bi bi-people me-2"></i>Integrante de Proyecto Grupal</h6>
                        <p class="mb-0">Te estás uniendo a un proyecto grupal existente. Los datos del proyecto ya fueron definidos por el primer integrante.</p>
                        <small class="text-muted">Código de grupo: <strong>{{ codigo }}</strong></small>
                    </div>
                {% endif %}

                <!-- Documentación general -->
                <div class="mb-4">
                    <label class="form-label">Documentación Requerida (PDF, ZIP, etc.)</label>
                    <input type="file" name="documentos" class="form-control" accept=".pdf,.zip,.rar,.doc,.docx,.png,.jpg,.jpeg" required>
                </div>

                <!-- Contenedor para archivos de integrantes -->
                <div id="archivos_integrantes_container"></div>

                <!-- Lista de integrantes agregados -->
                <div id="listaIntegrantes" class="container mt-4" style="display:none;">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Integrantes del Proyecto Agregados:</h5>
                        </div>
                        <div class="card-body">
                            <div id="integrantesContainer" class="row"></div>
                        </div>
                    </div>
                </div>

                <!-- Contenedor para archivos de proyectos adicionales -->
                <div id="archivos_proyectos_container"></div>

                <!-- Lista de proyectos adicionales -->
                <div id="listaProyectos" class="container mt-4" style="display:none;">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Proyectos adicionales agregados:</h5>
                        </div>
                        <div class="card-body">
                            <div id="proyectosContainer" class="row"></div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'detalle_evento_visitante' evento.eve_id %}" class="btn btn-outline-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Enviar Preinscripción</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Integrante (igual al tuyo actual) -->
<div class="modal fade" id="modalIntegrante" tabindex="-1" aria-labelledby="modalIntegranteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalIntegranteLabel">Inscribir Integrante del Proyecto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formIntegrante">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Identificación</label>
                            <input type="text" name="int_id" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Teléfono</label>
                            <input type="text" name="int_telefono" class="form-control" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombres</label>
                            <input type="text" name="int_nombres" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellidos</label>
                            <input type="text" name="int_apellidos" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" name="int_correo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Documentación Requerida</label>
                        <input type="file" name="int_documentos" class="form-control" accept=".pdf,.zip,.rar,.doc,.docx,.png,.jpg,.jpeg" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="agregarIntegrante()">Agregar Integrante</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Proyecto extra -->
<div class="modal fade" id="modalProyecto" tabindex="-1" aria-labelledby="modalProyectoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalProyectoLabel">Inscribir otro proyecto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formProyecto">
                    <div class="mb-3">
                        <label class="form-label">Título del Proyecto</label>
                        <input type="text" name="pro_titulo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea name="pro_descripcion" class="form-control" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Archivo del Proyecto</label>
                        <input type="file" name="pro_archivo" class="form-control"
                               accept=".pdf,.zip,.rar,.doc,.docx" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="agregarProyecto()">Agregar proyecto</button>
            </div>
        </div>
    </div>
</div>

<script>
let integrantes = [];
let contadorIntegrantes = 0;

let proyectosExtras = [];
let contadorProyectos = 0;

// Manejar cambio en tipo de participación
document.getElementById("tipo_participacion")?.addEventListener("change", function() {
    const tipo = this.value;
    const proyectoFields = document.getElementById("proyecto_fields");
    const grupalExtra = document.getElementById("grupal_extra");
    
    if (tipo === "individual") {
        proyectoFields.style.display = "block";
        grupalExtra.style.display = "none";
        integrantes = [];
        mostrarIntegrantes();
        limpiarArchivosIntegrantes();
    } else if (tipo === "grupal") {
        proyectoFields.style.display = "block";
        grupalExtra.style.display = "block";
    } else {
        proyectoFields.style.display = "none";
        grupalExtra.style.display = "none";
        integrantes = [];
        mostrarIntegrantes();
        limpiarArchivosIntegrantes();
    }
});


// ---------- INTEGRANTES ----------
function abrirModalIntegrante() {
    const modal = new bootstrap.Modal(document.getElementById('modalIntegrante'));
    modal.show();
}

function agregarIntegrante() {
    const form = document.getElementById('formIntegrante');
    const formData = new FormData(form);
    
    const id = formData.get('int_id');
    const nombres = formData.get('int_nombres');
    const apellidos = formData.get('int_apellidos');
    const correo = formData.get('int_correo');
    const telefono = formData.get('int_telefono');
    const archivo = formData.get('int_documentos');
    
    if (!id || !nombres || !apellidos || !correo || !archivo || archivo.size === 0) {
        alert('Por favor completa todos los campos obligatorios');
        return;
    }
    
    const duplicado = integrantes.find(int => int.id === id || int.correo === correo);
    if (duplicado) {
        alert('Ya existe un integrante con ese documento o correo');
        return;
    }
    
    contadorIntegrantes++;
    const integrante = {
        indice: contadorIntegrantes,
        id: id,
        nombres: nombres,
        apellidos: apellidos,
        correo: correo,
        telefono: telefono,
        archivo: archivo
    };
    
    integrantes.push(integrante);
    mostrarIntegrantes();
    agregarArchivoIntegrante(integrante);
    
    form.reset();
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalIntegrante'));
    modal.hide();
}

function agregarArchivoIntegrante(integrante) {
    const container = document.getElementById('archivos_integrantes_container');
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.name = `integrante_${integrante.indice - 1}_archivo`;
    fileInput.style.display = 'none';
    fileInput.id = `archivo_integrante_${integrante.indice}`;
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(integrante.archivo);
    fileInput.files = dataTransfer.files;
    container.appendChild(fileInput);
}

function limpiarArchivosIntegrantes() {
    const container = document.getElementById('archivos_integrantes_container');
    container.innerHTML = '';
}

function mostrarIntegrantes() {
    const container = document.getElementById('integrantesContainer');
    const lista = document.getElementById('listaIntegrantes');
    
    if (integrantes.length > 0) {
        lista.style.display = 'block';
        container.innerHTML = '';
        
        integrantes.forEach((integrante, index) => {
            const div = document.createElement('div');
            div.className = 'col-md-6 mb-3';
            div.innerHTML = `
                <div class="card bg-light">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${integrante.nombres} ${integrante.apellidos}</h6>
                                <small class="text-muted">${integrante.correo}</small><br>
                                <small class="text-muted">Doc: ${integrante.id}</small>
                                ${integrante.telefono ? `<br><small class="text-muted">Tel: ${integrante.telefono}</small>` : ''}
                                <br><small class="text-success">Documento: ${integrante.archivo.name}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                    onclick="eliminarIntegrante(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    } else {
        lista.style.display = 'none';
    }
}

function eliminarIntegrante(index) {
    const integranteEliminado = integrantes[index];
    const archivoInput = document.getElementById(`archivo_integrante_${integranteEliminado.indice}`);
    if (archivoInput) archivoInput.remove();
    integrantes.splice(index, 1);
    mostrarIntegrantes();
    limpiarArchivosIntegrantes();
    integrantes.forEach((integrante, newIndex) => {
        const container = document.getElementById('archivos_integrantes_container');
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.name = `integrante_${newIndex}_archivo`;
        fileInput.style.display = 'none';
        fileInput.id = `archivo_integrante_${integrante.indice}`;
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(integrante.archivo);
        fileInput.files = dataTransfer.files;
        container.appendChild(fileInput);
    });
}


// ---------- PROYECTOS ADICIONALES ----------
function abrirModalProyecto() {
    const modal = new bootstrap.Modal(document.getElementById('modalProyecto'));
    modal.show();
}

function agregarProyecto() {
    const form = document.getElementById('formProyecto');
    const formData = new FormData(form);

    const titulo = formData.get('pro_titulo');
    const descripcion = formData.get('pro_descripcion');
    const archivo = formData.get('pro_archivo');

    if (!titulo || !descripcion || !archivo || archivo.size === 0) {
        alert('Por favor completa todos los campos del proyecto adicional.');
        return;
    }

    contadorProyectos++;
    const proyecto = {
        indice: contadorProyectos,
        titulo: titulo,
        descripcion: descripcion,
        archivo: archivo
    };

    proyectosExtras.push(proyecto);
    mostrarProyectos();
    agregarArchivoProyecto(proyecto);

    form.reset();
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalProyecto'));
    modal.hide();
}

function mostrarProyectos() {
    const container = document.getElementById('proyectosContainer');
    const lista = document.getElementById('listaProyectos');

    if (proyectosExtras.length > 0) {
        lista.style.display = 'block';
        container.innerHTML = '';

        proyectosExtras.forEach((proyecto, index) => {
            const div = document.createElement('div');
            div.className = 'col-md-6 mb-3';
            div.innerHTML = `
                <div class="card bg-light">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${proyecto.titulo}</h6>
                                <small class="text-muted">Archivo: ${proyecto.archivo.name}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    onclick="eliminarProyecto(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    } else {
        lista.style.display = 'none';
    }
}

function agregarArchivoProyecto(proyecto) {
    const container = document.getElementById('archivos_proyectos_container');
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.name = `proyecto_extra_${proyecto.indice - 1}_archivo`;  // <- nombre que ve la vista
    fileInput.style.display = 'none';
    fileInput.id = `archivo_proyecto_${proyecto.indice}`;
    const dt = new DataTransfer();
    dt.items.add(proyecto.archivo);
    fileInput.files = dt.files;
    container.appendChild(fileInput);
}

function eliminarProyecto(index) {
    const proyectoEliminado = proyectosExtras[index];
    const archivoInput = document.getElementById(`archivo_proyecto_${proyectoEliminado.indice}`);
    if (archivoInput) archivoInput.remove();

    proyectosExtras.splice(index, 1);
    mostrarProyectos();

    const container = document.getElementById('archivos_proyectos_container');
    container.innerHTML = '';
    proyectosExtras.forEach((proyecto, newIndex) => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.name = `proyecto_extra_${newIndex}_archivo`;
        fileInput.style.display = 'none';
        fileInput.id = `archivo_proyecto_${proyecto.indice}`;
        const dt = new DataTransfer();
        dt.items.add(proyecto.archivo);
        fileInput.files = dt.files;
        container.appendChild(fileInput);
    });
}


// ---------- Submit del formulario principal ----------
document.getElementById('formPrincipal').addEventListener('submit', function(e) {
    const tipo = document.getElementById('tipo_participacion')?.value;

    // Integrantes para grupal
    if (tipo === 'grupal' && integrantes.length > 0) {
        integrantes.forEach((integrante, index) => {
            const campos = ['id', 'nombres', 'apellidos', 'correo', 'telefono'];
            campos.forEach(campo => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `integrante_${index}_${campo}`;
                input.value = integrante[campo] || '';
                this.appendChild(input);
            });
        });
        const inputCount = document.createElement('input');
        inputCount.type = 'hidden';
        inputCount.name = 'total_integrantes';
        inputCount.value = integrantes.length;
        this.appendChild(inputCount);
    }

    // Proyectos adicionales
    if (proyectosExtras.length > 0) {
        proyectosExtras.forEach((proyecto, index) => {
            const inputTitulo = document.createElement('input');
            inputTitulo.type = 'hidden';
            inputTitulo.name = `proyecto_extra_${index}_titulo`;
            inputTitulo.value = proyecto.titulo;
            this.appendChild(inputTitulo);

            const inputDesc = document.createElement('input');
            inputDesc.type = 'hidden';
            inputDesc.name = `proyecto_extra_${index}_descripcion`;
            inputDesc.value = proyecto.descripcion;
            this.appendChild(inputDesc);
        });
        const inputCountProy = document.createElement('input');
        inputCountProy.type = 'hidden';
        inputCountProy.name = 'total_proyectos_extras';
        inputCountProy.value = proyectosExtras.length;
        this.appendChild(inputCountProy);
    }
});
</script>
{% endblock %}